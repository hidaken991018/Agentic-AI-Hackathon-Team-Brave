@startuml hearing-sequence
title Life Compass - ヒアリングフェーズ AIエージェント詳細シーケンス
skinparam noteBorderColor #888888

participant "Backend" as Backend
participant "Agent Engine\n(ADK Agent)" as Agent
participant "Agent Engine\nSessions" as Sessions
participant "Gemini API" as LLM
participant "Firestore" as Firestore
participant "Cloud SQL" as CloudSQL

note over Backend, Firestore
  【概要】
  ユーザーからの入力データ（定量/自由記述/価値観）を受け取り、
  AIエージェントが文脈理解・構造化を行い、ヒアリングJSONを生成する。

  【主要な仕様】
  ・セッション有効期限: 10日間（途中再開可能）
  ・追加質問: 最大3回まで
  ・エラー時: 自動リトライ（最大2回）後にエラー返却
  ・データ保存: ヒアリングJSON + ユーザー特性をFirestoreに永続化
  ・FirestoreへのWrite: Backendのみが実行（Agentは読み取り専用）
end note

== 新規セッション開始 ==
Backend -> Agent : セッション開始要求(user_id)
activate Agent

Agent -> Sessions : セッション作成(user_id, ttl=10日)
activate Sessions
Sessions --> Agent : session_id, 初期状態
deactivate Sessions

note over Agent, Firestore : Tool: fetch_user_profile (Read Only)
Agent -> Firestore : 既存ユーザー特性取得
Firestore --> Agent : user_profile（存在すれば）

alt ユーザー特性あり
  Agent -> Sessions : セッション状態更新\n(user_profile設定)
end

Agent --> Backend : session_id, 初期状態
deactivate Agent

== 定量データ受信 ==
Backend -> Agent : 定量データ送信(session_id, data)
activate Agent

Agent -> Sessions : セッションへ保存
activate Sessions
Sessions --> Agent : 
deactivate Sessions

Agent --> Backend : 受信確認
deactivate Agent

== 定性データ受信（自由記述/価値観/感情） ==
Backend -> Agent : 定性データ送信\n(session_id, content)
activate Agent
Agent -> Agent:  物価上昇率や収入成長率を算出
Agent -> LLM : 構造化出力生成
activate LLM
LLM --> Agent : 
deactivate LLM

Agent --> Backend : 受信確認
deactivate Agent

== 追加質問判定 ==
loop 追加質問フェーズ (max 3回/)

  Backend -> Agent : 追加質問要求(session_id)
  activate Agent

  Agent -> Agent: 整合性・不足情報チェック

  alt  整合性・不足情報チェックNG

    Agent -> LLM : 構造化出力生成\n(追加質問生成指示)
    activate LLM
    LLM --> Agent : 不整合/不足情報に関する追加質問リスト
    deactivate LLM
    Agent -> Sessions : セッション状態更新\n(質問回数+1)
    Agent --> Backend : 追加質問リスト



  else 整合性・不足情報チェックOK
    Agent --> Backend : 追加質問なし（ヒアリング完了通知）
    deactivate Agent
    Backend -> Backend: break loop
    
  end
end 

== ヒアリングJSON作成・永続化 ==
Backend -> Agent : ヒアリングJSON作成(session_id)
activate Agent
Agent -> Agent: ヒアリングJSON作成指示生成
Agent -> LLM : 構造化出力生成\n(最終JSON整形指示)
activate LLM
LLM --> Agent : ヒアリングJSON
deactivate LLM

Agent -> Sessions : セッション状態更新\n(ヒアリングJSON保存)

Agent --> Backend : ヒアリングJSON, ユーザー特性
deactivate Agent

note over Backend, Firestore
  BackendがFirestoreへの書き込みを実行
end note
activate Backend
Backend -> Firestore : ヒアリングJSON保存
Firestore --> Backend : 保存完了
Backend -> Firestore : ユーザー特性保存/更新
Firestore --> Backend : 保存完了
deactivate Backend

note right Firestore
  【ヒアリングJSON】
  一連のヒアリングに関するデータ
  （定量データ、目標、タイムライン等）
  
  【ユーザー特性】
  変動しにくい価値観・考え方
  （リスク許容度、計画志向、優先軸等）
  ※次回ヒアリング時に再利用
end note

== ライフプラン表受信〜結果生成・永続化 ==
Backend -> Agent : ライフプラン表送信・生成要求(session_id, ライフプランJSON TB)
activate Agent

Agent -> Sessions : セッション状態更新\n(ライフプランJSON TB保存)
activate Sessions
Sessions --> Agent : 更新完了
deactivate Sessions

' --- ライフイベント生成 ---
Agent -> LLM : 構造化出力生成\n(ライフイベント生成指示)
activate LLM
note right LLM
  入力:
  - ヒアリングJSON（目標、家族構成、タイムライン）
  - ライフプラン表（数値）
  
  出力:
  - 各年のライフイベント
  - イベントの財務インパクト
end note
LLM --> Agent : ライフイベントJSON
deactivate LLM

Agent -> Sessions : セッション状態更新\n(life_events保存)

' --- コメント生成 ---
Agent -> LLM : 構造化出力生成\n(コメント生成指示)
activate LLM
note right LLM
  入力:
  - ライフプラン表（数値）
  - ライフイベント
  - ユーザー特性（価値観、リスク許容度）
  
  出力:
  - 全体サマリー
  - リスクポイント（資産マイナス時期等）
  - ポジティブポイント
  - 年代別コメント
end note
LLM --> Agent : コメントJSON
deactivate LLM

Agent -> Sessions : セッション状態更新\n(comments保存)

' --- チェックリスト生成 ---
Agent -> LLM : 構造化出力生成\n(チェックリスト生成指示)
activate LLM
note right LLM
  入力:
  - ヒアリングJSON（現状、目標）
  - ライフプラン表（数値）
  - ライフイベント
  - コメント（リスクポイント）
  - ユーザー特性
  
  出力:
  - 優先度付きアクションリスト
  - 各アクションの期待効果
  - 推奨時期
end note
LLM --> Agent : チェックリストJSON
deactivate LLM

Agent -> Sessions : セッション状態更新\n(checklist保存, status: completed)

Agent --> Backend : 生成結果\n(ライフイベント, コメント, チェックリスト)
deactivate Agent

note over Backend, CloudSQL
  BackendがCloudSQL/Firestoreへの書き込みを実行
end note
activate Backend
Backend -> CloudSQL : ライフプランメタデータ保存
CloudSQL --> Backend : 保存完了
Backend -> Firestore : ライフプランコンテンツ保存
Firestore --> Backend : 保存完了
deactivate Backend


== エラーハンドリング（共通） ==
note over Agent, LLM
  【LLM構造化出力失敗時】
  1. 自動リトライ（最大2回）
  2. それでも失敗 → Backend にエラー返却
end note

note over Backend, CloudSQL
  【CloudSQL保存失敗時（Backend側で発生）】
  1. 自動リトライ（最大2回）
  2. それでも失敗 → エラーレスポンス返却
  ※ Sessions の状態は保持されるため再試行可能
end note

@enduml
